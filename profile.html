<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Tài khoản của tôi | Chợ thuê đồ SV</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        :root {
            --primary: #1976d2;
            --muted: #6b7280;
            --bg: #f5f7ff
        }

        body {
            font-family: Segoe UI, Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 24px
        }

        .wrap {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            padding: 22px;
            box-shadow: 0 8px 30px rgba(16,24,40,0.06)
        }

        .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        .title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            color: var(--primary);
            font-weight: 700
        }

        .profile-grid {
            display: flex;
            gap: 24px;
            margin-top: 18px;
            flex-wrap: wrap
        }

        .col-left {
            width: 220px;
            min-width: 180px
        }

        .avatar {
            width: 180px;
            height: 180px;
            border-radius: 12px;
            background: #eaf3ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 44px;
            color: var(--primary);
            font-weight: 800;
            overflow: hidden;
            position: relative;
        }

            .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .meta {
            margin-top: 12px;
            color: var(--muted);
            font-size: 14px
        }

        .col-right {
            flex: 1;
            min-width: 280px
        }

        label {
            display: block;
            font-weight: 600;
            margin-top: 12px;
            color: #111
        }

        input[type="text"], input[type="email"], textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6eef8;
            margin-top: 6px;
            box-sizing: border-box
        }

        textarea {
            resize: vertical;
            min-height: 90px
        }

        .actions {
            margin-top: 14px;
            display: flex;
            gap: 10px
        }

        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700
        }

            .btn.secondary {
                background: #eef3ff;
                color: var(--primary);
                border: 1px solid #dbe9fb
            }

        .small {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px
        }

        .section {
            margin-top: 22px;
            border-top: 1px dashed #eef2f7;
            padding-top: 18px
        }

        .file-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn.ghost {
            background: transparent;
            color: var(--primary);
            border: 1px dashed #cfe3ff;
            padding: 8px 10px;
            border-radius: 8px;
        }

        .error {
            color: #b00;
            margin-top: 8px;
            display: none;
        }

        @media (max-width:720px) {
            .profile-grid {
                flex-direction: column
            }

            .col-left {
                width: 100%;
                display: flex;
                justify-content: center
            }

            .avatar {
                width: 120px;
                height: 120px;
                font-size: 32px
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="head">
            <div class="title"><i class="fa fa-user"></i> Tài khoản của tôi</div>
            <div>
                <button class="btn" id="backHome">Về Trang Chủ</button>
            </div>
        </div>

        <div id="profileArea" class="profile-grid" aria-live="polite">
            <!-- content rendered by JS -->
        </div>

        <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700">Bảo mật & Tùy chọn</div>
                <div class="small">Quản lý mật khẩu và tùy chọn thông báo</div>
            </div>

            <label>Đổi mật khẩu (demo)</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <input id="pwdOld" type="password" placeholder="Mật khẩu cũ" style="max-width:240px">
                <input id="pwdNew" type="password" placeholder="Mật khẩu mới" style="max-width:240px">
                <button class="btn secondary" id="btnChangePwd">Thay đổi</button>
            </div>
            <div id="pwdMsg" class="small" style="color:var(--muted)"></div>
        </div>
    </div>

    <script>
        const AUTH_KEY = 'authUser';
        const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB

        function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
        function getAuthUser() { try { return JSON.parse(localStorage.getItem(AUTH_KEY) || 'null'); } catch (e) { return null; } }
        function setAuthUser(u) { if (!u) localStorage.removeItem(AUTH_KEY); else localStorage.setItem(AUTH_KEY, JSON.stringify(u)); }

        function getInitials(name = '') { return (name.split(' ').filter(Boolean).map(n => n[0]).slice(0, 2).join('') || 'U').toUpperCase(); }

        function renderProfile() {
            const user = getAuthUser();
            const area = document.getElementById('profileArea');
            if (!user) {
                area.innerHTML = `<div style="padding:24px">Bạn chưa đăng nhập. Vui lòng <a href="login.html">Đăng nhập</a>.</div>`;
                return;
            }

            const avatarHtml = user.avatar
                ? `<img id="avatarImg" src="${escapeHtml(user.avatar)}" alt="avatar">`
                : `<div id="avatarInitials" class="avatar">${escapeHtml(getInitials(user.name || ''))}</div>`;

            area.innerHTML = `
          <div class="col-left">
            <div id="avatarFrame" class="avatar">
              ${ user.avatar ? `<img id="avatarImg" src="${escapeHtml(user.avatar)}" alt="avatar">` : `<div id="avatarInitials" style="font-size:44px;color:var(--primary);font-weight:800">${escapeHtml(getInitials(user.name || ''))}</div>`}
            </div>

            <div class="file-controls">
              <input id="fileInput" type="file" accept="image/*" style="display:none">
              <button class="btn secondary" id="btnUpload">Chọn ảnh</button>
              <button class="btn ghost" id="btnRemove">Xóa ảnh</button>
            </div>

            <div class="meta">Tên: <strong>${escapeHtml(user.name || '')}</strong></div>
            <div class="meta">Email: <strong>${escapeHtml(user.email || '')}</strong></div>
          </div>

          <div class="col-right">
            <label>Họ và tên</label>
            <input id="inpName" type="text" value="${escapeHtml(user.name || '')}" />

            <label>Email</label>
            <input id="inpEmail" type="email" value="${escapeHtml(user.email || '')}" />

            <label>Địa chỉ (tùy chọn)</label>
            <input id="inpAddress" type="text" value="${escapeHtml(user.address || '')}" />

            <label>Ảnh đại diện (URL)</label>
            <input id="inpAvatarUrl" type="text" value="${escapeHtml(user.avatar || '')}" placeholder="https://..." />

            <label>Giới thiệu ngắn</label>
            <textarea id="inpNote">${escapeHtml(user.note || '')}</textarea>

            <div class="actions">
              <button class="btn" id="btnSave">Lưu thay đổi</button>
              <button class="btn secondary" id="btnLogout">Đăng xuất</button>
            </div>

            <div id="feedback" class="small" style="margin-top:8px">Lưu ý: ảnh được lưu cục bộ (localStorage). Nếu muốn lưu server, gửi API để đồng bộ.</div>
            <div id="error" class="error"></div>
          </div>
        `;

            // wire elements
            const fileInput = document.getElementById('fileInput');
            const btnUpload = document.getElementById('btnUpload');
            const btnRemove = document.getElementById('btnRemove');
            const avatarFrame = document.getElementById('avatarFrame');
            const inpAvatarUrl = document.getElementById('inpAvatarUrl');
            const errorEl = document.getElementById('error');

            // click upload -> open file picker
            btnUpload.onclick = () => fileInput.click();

            fileInput.onchange = async (e) => {
                errorEl.style.display = 'none';
                const f = e.target.files[0];
                if (!f) return;
                if (!f.type.startsWith('image/')) { showError('Vui lòng chọn file hình ảnh.'); return; }
                if (f.size > MAX_FILE_SIZE) { showError('Kích thước file quá lớn. Tối đa 2MB.'); return; }

                try {
                    const dataUrl = await fileToDataUrl(f);
                    setAvatarPreview(dataUrl);
                    inpAvatarUrl.value = dataUrl; // save data URL to avatar input
                } catch (err) {
                    showError('Không thể đọc file ảnh.');
                }
            };

            btnRemove.onclick = () => {
                inpAvatarUrl.value = '';
                removeAvatarPreview();
            };

            document.getElementById('btnSave').onclick = () => {
                const name = document.getElementById('inpName').value.trim();
                const email = document.getElementById('inpEmail').value.trim();
                const address = document.getElementById('inpAddress').value.trim();
                const avatar = document.getElementById('inpAvatarUrl').value.trim();
                const note = document.getElementById('inpNote').value.trim();

                const newUser = Object.assign({}, user, { name, email, address, avatar, note });
                try {
                    setAuthUser(newUser);
                    alert('Thông tin cá nhân đã được lưu.');
                    renderProfile(); // re-render to update avatar display
                } catch (e) {
                    showError('Không thể lưu thông tin: ' + (e.message || e));
                }
            };

            document.getElementById('btnLogout').onclick = () => {
                if (!confirm('Bạn có chắc muốn đăng xuất?')) return;
                setAuthUser(null);
                localStorage.removeItem('loggedIn');
                location.href = 'index.html';
            };

            function showError(msg) {
                errorEl.style.display = 'block';
                errorEl.textContent = msg;
            }
            function fileToDataUrl(file) {
                return new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.onload = () => resolve(r.result);
                    r.onerror = () => reject(new Error('Không thể đọc file.'));
                    r.readAsDataURL(file);
                });
            }
            function setAvatarPreview(dataUrl) {
                // update avatar frame
                const existingImg = avatarFrame.querySelector('img');
                const initials = avatarFrame.querySelector('#avatarInitials');
                if (existingImg) {
                    existingImg.src = dataUrl;
                } else {
                    if (initials) initials.remove();
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    avatarFrame.appendChild(img);
                }
            }
            function removeAvatarPreview() {
                const existingImg = avatarFrame.querySelector('img');
                if (existingImg) existingImg.remove();
                const initials = avatarFrame.querySelector('#avatarInitials');
                if (!initials) {
                    const user = getAuthUser();
                    const el = document.createElement('div');
                    el.id = 'avatarInitials';
                    el.style.fontSize = window.matchMedia('(max-width:720px)').matches ? '32px' : '44px';
                    el.style.color = 'var(--primary)';
                    el.style.fontWeight = '800';
                    el.textContent = getInitials(user ? user.name : '');
                    avatarFrame.appendChild(el);
                }
            }
        }

        // simple demo password change (no backend)
        document.getElementById('btnChangePwd') ?.addEventListener('click', () => {
            const oldp = document.getElementById('pwdOld').value;
            const newp = document.getElementById('pwdNew').value;
            const msg = document.getElementById('pwdMsg');
            if (!oldp || !newp) { msg.textContent = 'Vui lòng nhập mật khẩu cũ và mới.'; return; }
            msg.textContent = 'Đổi mật khẩu (demo) thành công.';
            setTimeout(() => msg.textContent = '', 3000);
        });

        document.getElementById('backHome').onclick = () => location.href = 'index.html';

        // initialize
        renderProfile();
    </script>
</body>
</html>